<script>
document.addEventListener('DOMContentLoaded', function() {
    // Auto-suggest (datalist) untuk semua field teks
    const autosuggestInputs = document.querySelectorAll('.autosuggest-field');
    autosuggestInputs.forEach(input => {
        const field = input.dataset.field;
        const datalistId = input.getAttribute('list');
        const datalist = document.getElementById(datalistId);
        let debounceTimer;

        function loadSuggestions(term = '') {
            const url = `/api/materials/field-values/${field}?search=${encodeURIComponent(term)}&limit=20`;
            fetch(url)
                .then(resp => resp.json())
                .then(values => {
                    while (datalist.firstChild) datalist.removeChild(datalist.firstChild);
                    values.forEach(v => {
                        const opt = document.createElement('option');
                        opt.value = v;
                        datalist.appendChild(opt);
                    });
                })
                .catch(() => {});
        }

        input.addEventListener('focus', () => loadSuggestions(''));
        input.addEventListener('input', function () {
            clearTimeout(debounceTimer);
            const term = this.value || '';
            debounceTimer = setTimeout(() => loadSuggestions(term), 250);
        });
    });
    
    // Load data untuk setiap dropdown field
    const dropdownFields = document.querySelectorAll('.dropdown-field');
    
    dropdownFields.forEach(select => {
        const field = select.dataset.field;
        
        fetch(`/api/materials/field-values/${field}`)
            .then(response => response.json())
            .then(values => {
                // Clear existing options except first
                while (select.options.length > 1) {
                    select.remove(1);
                }
                
                // Add values from database
                values.forEach(value => {
                    const option = document.createElement('option');
                    option.value = value;
                    option.textContent = value;
                    select.appendChild(option);
                });
                
                // Add "Input Manual" option
                const manualOption = document.createElement('option');
                manualOption.value = '__manual__';
                manualOption.textContent = '✏️ Ketik Manual...';
                manualOption.className = 'custom-input-option';
                select.appendChild(manualOption);
            });
        
        // Event untuk handle input manual
        select.addEventListener('change', function() {
            if (this.value === '__manual__') {
                const currentValue = prompt(`Masukkan ${this.name} baru:`);
                if (currentValue && currentValue.trim() !== '') {
                    // Tambah option baru
                    const newOption = document.createElement('option');
                    newOption.value = currentValue.trim();
                    newOption.textContent = currentValue.trim();
                    newOption.selected = true;
                    this.insertBefore(newOption, this.lastChild);
                } else {
                    this.value = '';
                }
            }
        });
    });

    // Photo upload functionality
    const photoInput = document.getElementById('photo');
    const photoPreview = document.getElementById('photoPreview');
    const photoPlaceholder = document.getElementById('photoPlaceholder');
    const photoPreviewArea = document.getElementById('photoPreviewArea');
    const uploadBtn = document.getElementById('uploadBtn');
    const deletePhotoBtn = document.getElementById('deletePhotoBtn');

    photoPreviewArea.addEventListener('click', function() {
        photoInput.click();
    });

    uploadBtn.addEventListener('click', function(e) {
        e.preventDefault();
        photoInput.click();
    });

    photoInput.addEventListener('change', function() {
        if (this.files && this.files[0]) {
            const reader = new FileReader();
            reader.onload = function(e) {
                photoPreview.src = e.target.result;
                photoPreview.style.display = 'block';
                photoPlaceholder.style.display = 'none';
                deletePhotoBtn.style.display = 'inline';
            };
            reader.readAsDataURL(this.files[0]);
        }
    });

    deletePhotoBtn.addEventListener('click', function(e) {
        e.preventDefault();
        e.stopPropagation();
        photoInput.value = '';
        photoPreview.src = '';
        photoPreview.style.display = 'none';
        photoPlaceholder.style.display = 'block';
        deletePhotoBtn.style.display = 'none';
    });

    // Kalkulasi berat bersih otomatis
    const packageUnit = document.getElementById('package_unit');
    const packageWeightGross = document.getElementById('package_weight_gross');
    const netWeightDisplay = document.getElementById('net_weight_display');

    function calculateNetWeight() {
        const selectedOption = packageUnit.options[packageUnit.selectedIndex];
        const packageWeight = parseFloat(selectedOption?.dataset?.weight) || 0;
        const grossWeight = parseFloat(packageWeightGross.value) || 0;

        if (grossWeight > 0 && packageWeight >= 0) {
            const netWeight = grossWeight - packageWeight;
            netWeightDisplay.textContent = netWeight.toFixed(2) + ' Kg';
            calculateComparisonPrice(netWeight);
        } else {
            netWeightDisplay.textContent = '-';
            calculateComparisonPrice(0);
        }
    }

    packageUnit.addEventListener('change', calculateNetWeight);
    packageWeightGross.addEventListener('input', calculateNetWeight);

    // Kalkulasi harga komparasi per kg
    const purchasePrice = document.getElementById('purchase_price');
    const comparisonPriceDisplay = document.getElementById('comparison_price_display');

    function calculateComparisonPrice(netWeight) {
        const price = parseFloat(purchasePrice.value) || 0;
        
        if (netWeight > 0 && price > 0) {
            const comparisonPrice = price / netWeight;
            comparisonPriceDisplay.value = Math.round(comparisonPrice).toLocaleString('id-ID');
        } else {
            comparisonPriceDisplay.value = '0';
        }
    }

    purchasePrice.addEventListener('input', function() {
        const selectedOption = packageUnit.options[packageUnit.selectedIndex];
        const packageWeight = parseFloat(selectedOption?.dataset?.weight) || 0;
        const grossWeight = parseFloat(packageWeightGross.value) || 0;
        const netWeight = grossWeight - packageWeight;
        
        if (netWeight > 0) {
            calculateComparisonPrice(netWeight);
        }
    });
});
</script>
