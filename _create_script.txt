document.addEventListener('DOMContentLoaded', function() {
    // Auto-suggest (datalist + dropdown kustom)
    const autosuggestInputs = document.querySelectorAll('.autosuggest-field');
    autosuggestInputs.forEach(input => {
        const field = input.dataset.field;
        const datalistId = input.getAttribute('list');
        const datalist = datalistId ? document.getElementById(datalistId) : null;
        const suggestList = document.getElementById(`${field}-suggest`);
        let debounceTimer;

        function populate(values) {
            if (datalist) {
                while (datalist.firstChild) datalist.removeChild(datalist.firstChild);
                values.forEach(v => {
                    const opt = document.createElement('option');
                    opt.value = v;
                    datalist.appendChild(opt);
                });
            }
            if (suggestList) {
                suggestList.innerHTML = '';
                values.forEach(v => {
                    const item = document.createElement('div');
                    item.className = 'autocomplete-item';
                    item.textContent = v;
                    item.addEventListener('click', function() {
                        input.value = v;
                        suggestList.style.display = 'none';
                    });
                    suggestList.appendChild(item);
                });
                suggestList.style.display = values.length > 0 ? 'block' : 'none';
            }
        }

        function loadSuggestions(term = '') {
            const url = `/api/materials/field-values/${field}?search=${encodeURIComponent(term)}&limit=20`;
            fetch(url)
                .then(resp => resp.json())
                .then(populate)
                .catch(() => {});
        }

        input.addEventListener('focus', () => loadSuggestions(''));
        input.addEventListener('input', function () {
            clearTimeout(debounceTimer);
            const term = this.value || '';
            debounceTimer = setTimeout(() => loadSuggestions(term), 200);
        });

        document.addEventListener('click', function(e) {
            if (suggestList && e.target !== input && !suggestList.contains(e.target)) {
                suggestList.style.display = 'none';
            }
        });
    });

    // Photo upload functionality
    const photoInput = document.getElementById('photo');
    const photoPreview = document.getElementById('photoPreview');
    const photoPlaceholder = document.getElementById('photoPlaceholder');
    const photoPreviewArea = document.getElementById('photoPreviewArea');
    const uploadBtn = document.getElementById('uploadBtn');
    const deletePhotoBtn = document.getElementById('deletePhotoBtn');

    photoPreviewArea.addEventListener('click', function() { photoInput.click(); });
    uploadBtn.addEventListener('click', function(e) { e.preventDefault(); photoInput.click(); });
    photoInput.addEventListener('change', function() {
        if (this.files && this.files[0]) {
            const reader = new FileReader();
            reader.onload = function(e) {
                photoPreview.src = e.target.result;
                photoPreview.style.display = 'block';
                photoPlaceholder.style.display = 'none';
                deletePhotoBtn.style.display = 'inline';
            };
            reader.readAsDataURL(this.files[0]);
        }
    });
    deletePhotoBtn.addEventListener('click', function(e) {
        e.preventDefault(); e.stopPropagation();
        photoInput.value = '';
        photoPreview.src = '';
        photoPreview.style.display = 'none';
        photoPlaceholder.style.display = 'block';
        deletePhotoBtn.style.display = 'none';
    });

    // Kalkulasi berat bersih otomatis
    const packageUnit = document.getElementById('package_unit');
    const packageWeightGross = document.getElementById('package_weight_gross');
    const netWeightDisplay = document.getElementById('net_weight_display');

    function calculateNetWeight() {
        const selectedOption = packageUnit.options[packageUnit.selectedIndex];
        const packageWeight = parseFloat(selectedOption?.dataset?.weight) || 0;
        const grossWeight = parseFloat(packageWeightGross.value) || 0;
        if (grossWeight > 0 && packageWeight >= 0) {
            const netWeight = grossWeight - packageWeight;
            netWeightDisplay.textContent = netWeight.toFixed(2) + ' Kg';
            calculateComparisonPrice(netWeight);
        } else {
            netWeightDisplay.textContent = '-';
            calculateComparisonPrice(0);
        }
    }
    packageUnit.addEventListener('change', calculateNetWeight);
    packageWeightGross.addEventListener('input', calculateNetWeight);

    // Kalkulasi harga komparasi per kg
    const purchasePrice = document.getElementById('purchase_price');
    const comparisonPriceDisplay = document.getElementById('comparison_price_display');
    function calculateComparisonPrice(netWeight) {
        const price = parseFloat(purchasePrice.value) || 0;
        if (netWeight > 0 && price > 0) {
            const comparisonPrice = price / netWeight;
            comparisonPriceDisplay.value = Math.round(comparisonPrice).toLocaleString('id-ID');
        } else {
            comparisonPriceDisplay.value = '0';
        }
    }
    purchasePrice.addEventListener('input', function() {
        const selectedOption = packageUnit.options[packageUnit.selectedIndex];
        const packageWeight = parseFloat(selectedOption?.dataset?.weight) || 0;
        const grossWeight = parseFloat(packageWeightGross.value) || 0;
        const netWeight = grossWeight - packageWeight;
        if (netWeight > 0) { calculateComparisonPrice(netWeight); }
    });
});
